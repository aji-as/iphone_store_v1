{% extends 'dashboard/base.html' %} {% load humanize %} {% load static %}
{%block content %}
<div
  class="p-4 sm:p-6 md:p-8 bg-gradient-to-br from-gray-100 to-gray-200 min-h-screen"
>
  <div class="max-w-7xl mx-auto">
    <!-- Header Section -->
    <header class="mb-6 sm:mb-8">
      <div
        class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4"
      >
        <div>
          <h1
            class="text-xl sm:text-2xl md:text-3xl font-bold text-gray-900 flex items-center"
          >
            <i
              class="fas fa-chart-line mr-3 text-indigo-600"
              aria-hidden="true"
            ></i>
            Data Penjualan
          </h1>
          <p class="text-gray-600 mt-1 sm:mt-2 text-sm sm:text-base">
            Analisis penjualan produk anda
          </p>
        </div>
        <div class="flex justify-end">
          <a href="{% url "dashboard:export_to_pdf" %}">
             <button
            class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition flex items-center"
            aria-label="Ekspor laporan penjualan"
          >
            <i class="fas fa-download mr-2" aria-hidden="true"></i>
            <span>Ekspor Laporan</span> 
          </button>
          </a>
         
        </div>
      </div>
    </header>

    <!-- Statistik Utama -->
    <section
      class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 sm:mb-8"
    >
      <div
        class="bg-white rounded-xl p-4 sm:p-5 shadow-sm border border-gray-200 transition-all duration-300 hover:shadow-md"
        role="region"
        aria-labelledby="total-orders"
      >
        <div class="flex items-center">
          <div
            class="p-3 rounded-lg bg-gradient-to-r from-blue-500 to-blue-600"
          >
            <i
              class="fas fa-shopping-cart text-primary text-xl"
              aria-hidden="true"
            ></i>
          </div>
          <div class="ml-4">
            <h2
              id="total-orders"
              class="text-gray-500 text-xs sm:text-sm font-medium"
            >
              Total Penjualan Produk
            </h2>
            <p class="text-xl sm:text-2xl font-bold text-gray-900 mt-1">
              {{ total_sold }}
            </p>
          </div>
        </div>
      </div>
      <div
        class="bg-white rounded-xl p-4 sm:p-5 shadow-sm border border-gray-200 transition-all duration-300 hover:shadow-md"
        role="region"
        aria-labelledby="total-products"
      >
        <div class="flex items-center">
          <div
            class="p-3 rounded-lg bg-gradient-to-r from-emerald-500 to-emerald-600"
          >
            <i class="fas fa-box text-primary text-xl" aria-hidden="true"></i>
          </div>
          <div class="ml-4">
            <h2
              id="total-products"
              class="text-gray-500 text-xs sm:text-sm font-medium"
            >
              Total Produk
            </h2>
            <p class="text-xl sm:text-2xl font-bold text-gray-900 mt-1">
              {{ total_products }}
            </p>
          </div>
        </div>
      </div>
      <div
        class="bg-white rounded-xl p-4 sm:p-5 shadow-sm border border-gray-200 transition-all duration-300 hover:shadow-md"
        role="region"
        aria-labelledby="total-pendapatan"
      >
        <div class="flex items-center">
          <div
            class="p-3 rounded-lg bg-gradient-to-r from-amber-500 to-amber-600"
          >
            <i
              class="fas fa-dollar-sign text-primary text-xl"
              aria-hidden="true"
            ></i>
          </div>
          <div class="ml-4">
            <h2
              id="total-pendapatan"
              class="text-gray-500 text-xs sm:text-sm font-medium"
            >
              Total Pendapatan
            </h2>
            <p class="text-xl sm:text-2xl font-bold text-gray-900 mt-1">
              Rp{{ total_sales|floatformat:0|intcomma|default:"0" }}
            </p>
          </div>
        </div>
      </div>
      <div
        class="bg-white rounded-xl p-4 sm:p-5 shadow-sm border border-gray-200 transition-all duration-300 hover:shadow-md"
        role="region"
        aria-labelledby="customer-aktif"
      >
        <div class="flex items-center">
          <div
            class="p-3 rounded-lg bg-gradient-to-r from-violet-500 to-violet-600"
          >
            <i class="fas fa-box-open text-primary text-xl" aria-hidden="true"></i>
          </div>
          <div class="ml-4">
            <h2
              id="customer-aktif"
              class="text-gray-500 text-xs sm:text-sm font-medium"
            >
              Total Product dengan stock 0
            </h2>
            <p class="text-xl sm:text-2xl font-bold text-gray-900 mt-1">
              {{ total_customers|default:0 }}
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- Grafik Utama -->
    <section
      class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6 mb-6 sm:mb-8"
    >
      <!-- Grafik Penjualan Produk -->
      <div
        class="bg-white rounded-xl p-4 sm:p-6 shadow-lg"
        role="region"
        aria-labelledby="penjualan-produk"
      >
        <div
          class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4 sm:mb-6"
        >
          <div class="mb-3 sm:mb-0">
            <h2
              id="penjualan-produk"
              class="text-lg sm:text-xl font-semibold text-gray-800 flex items-center"
            >
              <i
                class="fas fa-chart-bar mr-2 text-indigo-600"
                aria-hidden="true"
              ></i>
              Penjualan per Produk
            </h2>
          </div>
          <div
            class="flex space-x-2"
            role="group"
            aria-label="Filter waktu penjualan"
          >
            <button
              class="px-3 py-1 text-xs sm:text-sm bg-gray-100 rounded-lg text-gray-700 hover:bg-gray-200"
            >
              7H
            </button>
            <button
              class="px-3 py-1 text-xs sm:text-sm bg-indigo-100 text-indigo-700 rounded-lg"
            >
              30H
            </button>
            <button
              class="px-3 py-1 text-xs sm:text-sm bg-gray-100 rounded-lg text-gray-700 hover:bg-gray-200"
            >
              Tahun
            </button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <canvas id="bars" height="240" class="w-full"></canvas>
        </div>
      </div>

      <!-- Grafik Kota Penjualan iPhone -->
      <div
        class="bg-white rounded-xl p-4 sm:p-6 shadow-lg"
        role="region"
        aria-labelledby="distribusi-kota"
      >
        <h2
          id="distribusi-kota"
          class="text-lg sm:text-xl font-semibold text-gray-800 mb-4 sm:mb-6 flex items-center"
        >
          <i
            class="fas fa-map-marked-alt mr-2 text-indigo-600"
            aria-hidden="true"
          ></i>
          Distribusi Penjualan per Kota
        </h2>
        <div class="overflow-x-auto">
          <canvas id="pie" height="240" class="w-full"></canvas>
        </div>
        <div class="mt-4 text-center">
          <p class="text-gray-600 text-sm">
            Grafik di atas menunjukkan distribusi penjualan berdasarkan lokasi
            geografis
          </p>
        </div>
      </div>
    </section>

    <!-- Grafik Lanjutan -->
    <section class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
      <!-- Grafik Umur Pembeli -->
      <div
        class="bg-white rounded-xl p-4 sm:p-6 shadow-lg"
        role="region"
        aria-labelledby="segmentasi-usia"
      >
        <h2
          id="segmentasi-usia"
          class="text-lg sm:text-xl font-semibold text-gray-800 mb-4 sm:mb-6 flex items-center"
        >
          <i
            class="fas fa-user-friends mr-2 text-indigo-600"
            aria-hidden="true"
          ></i>
          Segmentasi Usia Pembeli
        </h2>
        <div class="overflow-x-auto">
          <canvas id="line" height="240" class="w-full"></canvas>
        </div>
      </div>

      <!-- Grafik Gender Pembeli -->
      <div
        class="bg-white rounded-xl p-4 sm:p-6 shadow-lg"
        role="region"
        aria-labelledby="distribusi-gender"
      >
        <h2
          id="distribusi-gender"
          class="text-lg sm:text-xl font-semibold text-gray-800 mb-4 sm:mb-6 flex items-center"
        >
          <i
            class="fas fa-venus-mars mr-2 text-indigo-600"
            aria-hidden="true"
          ></i>
          Distribusi Gender Pembeli
        </h2>
        <div class="overflow-x-auto">
          <canvas id="genderChart" height="240" class="w-full"></canvas>
        </div>
      </div>
    </section>


   
    <!-- Section Prediksi -->
    <section class="pt-10  ">
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white tracking-tight">
          Prediksi Penjualan
        </h1>
        <form method="post">
          {% csrf_token %}
          <button
            type="submit"
            class="inline-flex items-center gap-1.5 px-4 py-2 font-semibold text-white transition-all duration-200 ease-in-out transform bg-primary rounded-full shadow-md text-sm hover:bg-primary/80 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary focus:ring-offset-white dark:focus:ring-offset-gray-900"
          >
            <i class="fas fa-sync-alt fa-fw"></i>
            <span>Refresh</span>
          </button>
        </form>
      </div>

      <div
        class="w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl shadow-md p-6 transition-all duration-300 hover:shadow-lg"
      >
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-6">
          Berdasarkan data penjualan terbaru, hasil prediksi sementara adalah:
        </p>

        {% if produk_populer or prediksi_tren or saran_admin %}
        <div class="space-y-6">
          <div
            class="p-4 border-l-4 border-primary bg-blue-50 dark:bg-blue-900/20 rounded-lg"
          >
            <h2
              class="text-lg font-semibold text-primary dark:text-blue-300 mb-2 flex items-center"
            >
              <i class="fas fa-chart-line w-5 text-center mr-2"></i>
              <span>Prediksi Tren</span>
            </h2>
            <p class="text-gray-700 dark:text-gray-300 pl-7">
              {{ prediksi_tren }}
            </p>
          </div>

          <div
            class="p-4 border-l-4 border-primary bg-blue-50 dark:bg-blue-900/20 rounded-lg"
          >
            <h2
              class="text-lg font-semibold text-primary dark:text-blue-300 mb-2 flex items-center"
            >
              <i class="fas fa-star w-5 text-center mr-2"></i>
              <span>Produk Populer</span>
            </h2>
            <ul
              class="list-disc list-inside text-gray-700 dark:text-gray-300 pl-7"
            >
              {% for item in produk_populer %}
              <li>{{ item }}</li>
              {% endfor %}
            </ul>
          </div>

          <div
            class="p-4 border-l-4 border-primary bg-blue-50 dark:bg-blue-900/20 rounded-lg"
          >
            <h2
              class="text-lg font-semibold text-primary dark:text-blue-300 mb-2 flex items-center"
            >
              <i class="fas fa-lightbulb w-5 text-center mr-2"></i>
              <span>Saran untuk Admin</span>
            </h2>
            <p class="text-gray-700 dark:text-gray-300 pl-7">
              {{ saran_admin }}
            </p>
          </div>
        </div>

        {% else %}
        <p class="text-gray-600 dark:text-gray-400 italic">
          Belum ada data prediksi tersedia.
        </p>
        {% endif %}
      </div>
    </section>

  </div>
</div>

<!-- Font Awesome for icons -->
<script
  src="https://kit.fontawesome.com/a076d05399.js"
  crossorigin="anonymous"
></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // Data dari Django context
  const productLabels = {{ product_labels|safe }};
  const productValues = {{ product_values|safe }};
  const cityLabels = {{ city_labels|safe }};
  const cityValues = {{ city_values|safe }};
  const ageLabels = {{ age_labels|safe }};
  const ageValues = {{ age_values|safe }};
  const genderLabels = {{ gender_labels|safe }};
  const genderValues = {{ gender_values|safe }};

  // --- Grafik Bar: Penjualan Produk ---
  new Chart(document.getElementById('bars'), {
    type: 'bar',
    data: {
      labels: productLabels,
      datasets: [{
        label: 'Jumlah Terjual',
        data: productValues,
        backgroundColor: [
          '#6366F1', '#8B5CF6', '#EC4899',
          '#F59E0B', '#10B981', '#3B82F6'
        ],
        borderWidth: 0,
        borderRadius: 6,
        borderSkipped: false,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.9)',
          padding: 12,
          titleFont: {
            size: 14,
            weight: 'bold'
          },
          bodyFont: {
            size: 13
          },
          titleColor: '#fff',
          bodyColor: '#fff',
          borderColor: '#4F46E5',
          borderWidth: 1,
          cornerRadius: 6,
          displayColors: false,
          callbacks: {
            title: function(context) {
              return context[0].label;
            },
            label: function(context) {
              return 'Terjual: ' + context.parsed.y + ' unit';
            },
            afterLabel: function(context) {
              const total = productValues.reduce((a, b) => a + b, 0);
              const percentage = ((context.parsed.y / total) * 100).toFixed(1);
              return 'Persentase: ' + percentage + '%';
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: {
            color: 'rgba(0, 0, 0, 0.05)'
          },
          ticks: {
            callback: function(value) {
              if (value >= 1000) {
                return (value / 1000).toFixed(1) + 'k';
              }
              return value;
            }
          }
        },
        x: {
          grid: {
            display: false
          },
          ticks: {
            maxRotation: 45,
            minRotation: 0
          }
        }
      }
    }
  });

  // --- Grafik Pie: Kota Penjualan iPhone ---
  new Chart(document.getElementById('pie'), {
    type: 'pie',
    data: {
      labels: cityLabels,
      datasets: [{
        label: 'Penjualan iPhone per Kota',
        data: cityValues,
        backgroundColor: [
          '#2563EB', '#0EA5E9', '#14B8A6',
          '#FACC15', '#F43F5E', '#475569'
        ],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'right',
          labels: {
            boxWidth: 12,
            padding: 15,
            usePointStyle: true,
            pointStyle: 'circle',
            font: {
              size: 12
            }
          }
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.9)',
          padding: 12,
          titleFont: {
            size: 14,
            weight: 'bold'
          },
          bodyFont: {
            size: 13
          },
          titleColor: '#fff',
          bodyColor: '#fff',
          borderColor: '#4F46E5',
          borderWidth: 1,
          cornerRadius: 6,
          callbacks: {
            label: function(context) {
              const label = context.label || '';
              const value = context.parsed;
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = ((value / total) * 100).toFixed(1);
              return label + ': ' + value + ' unit (' + percentage + '%)';
            }
          }
        }
      }
    }
  });

  // --- Grafik Line: Umur Pembeli iPhone ---
  new Chart(document.getElementById('line'), {
    type: 'line',
    data: {
      labels: ageLabels,
      datasets: [{
        label: 'Jumlah Pembeli',
        data: ageValues,
        borderColor: '#10B981',
        backgroundColor: 'rgba(16, 185, 129, 0.1)',
        borderWidth: 3,
        pointBackgroundColor: '#10B981',
        pointRadius: 5,
        pointHoverRadius: 7,
        fill: true,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.9)',
          padding: 12,
          titleFont: {
            size: 14,
            weight: 'bold'
          },
          bodyFont: {
            size: 13
          },
          titleColor: '#fff',
          bodyColor: '#fff',
          borderColor: '#4F46E5',
          borderWidth: 1,
          cornerRadius: 6,
          callbacks: {
            label: function(context) {
              return 'Jumlah Pembeli: ' + context.parsed.y;
            },
            afterLabel: function(context) {
              const total = ageValues.reduce((a, b) => a + b, 0);
              const percentage = ((context.parsed.y / total) * 100).toFixed(1);
              return 'Kontribusi: ' + percentage + '% dari total';
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: {
            color: 'rgba(0, 0, 0, 0.05)'
          },
          ticks: {
            callback: function(value) {
              if (value >= 1000) {
                return (value / 1000).toFixed(1) + 'k';
              }
              return value;
            }
          }
        },
        x: {
          grid: {
            display: false
          }
        }
      }
    }
  });

  // --- Grafik Doughnut: Gender Pembeli iPhone ---
  new Chart(document.getElementById('genderChart'), {
    type: 'doughnut',
    data: {
      labels: genderLabels,
      datasets: [{
        data: genderValues,
        backgroundColor: [
          '#1D4ED8', '#E879F9', '#6366F1'  
        ],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '70%',
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            boxWidth: 12,
            padding: 15,
            usePointStyle: true,
            pointStyle: 'circle',
            font: {
              size: 12
            }
          }
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.9)',
          padding: 12,
          titleFont: {
            size: 14,
            weight: 'bold'
          },
          bodyFont: {
            size: 13
          },
          titleColor: '#fff',
          bodyColor: '#fff',
          borderColor: '#4F46E5',
          borderWidth: 1,
          cornerRadius: 6,
          callbacks: {
            label: function(context) {
              const label = context.label || '';
              const value = context.parsed;
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = ((value / total) * 100).toFixed(1);
              return label + ': ' + value + ' (' + percentage + '%)';
            }
          }
        }
      }
    }
  });
</script>
{% endblock %}
