{% extends 'orders\\base.html' %}
{% load humanize %}
{% load custom_filters %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8">
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-2">Daftar Pesanan</h1>
    <p class="text-gray-600">Cari dan lihat semua pesanan Anda</p>
  </div>

 <!-- Search Section -->

<div class="mb-8 bg-white rounded-2xl shadow-md p-6">
  <label for="order-search" class="block text-sm font-semibold text-gray-700 mb-3">
    Cari Pesanan
  </label>

  <div class="flex w-full rounded-full border border-gray-300 bg-gray-50 overflow-hidden focus-within:ring-2 focus-within:ring-primary transition">
    <!-- Input -->
    <input 
      type="text" 
      id="order-search" 
      placeholder="Masukkan ID Pesanan (contoh: ORD20251015-001)" 
      class="flex-1 py-3 pl-5 pr-3 text-gray-800 bg-gray-50 border-none focus:ring-0 focus:outline-none text-sm"
      value="{{ search_query|default:'' }}"
    >

    <!-- Tombol -->
    <button 
      id="search-btn" 
      class=" text-gray-800 bg-gray-50 border-none focus:ring-2 focus:ring-primary  font-semibold px-6 py-3 text-sm hover:bg-primary hover:text-secondary transition duration-200 flex items-center justify-center gap-2"
    >
      <i class="fas fa-search"></i> Cari
    </button>
  </div>

  <!-- Tips -->
  <div id="search-help" class="mt-4 text-sm text-gray-500 text-center md:text-left">
    ðŸ’¡ <span class="font-medium">Tips:</span> Gunakan ID pesanan lengkap untuk hasil pencarian yang akurat.
  </div>
</div>


  <!-- Orders List -->
  <div id="orders-container">
    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
      <!-- Responsive container for mobile -->
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 ">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Pesanan</th>
              <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produk</th>
              <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Harga</th>
              <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jumlah</th>
              <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Harga</th>
              <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
              <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
            </tr>
          </thead>
          <tbody id="orders-list" class="bg-white divide-y divide-gray-200">
            {% for order in orders %}
            <tr class="hover:bg-gray-50 transition-colors fade-in order-row" data-order-id="{{ order.order_id }}">
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="font-medium text-gray-900">{{ order.order_id }}</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                  {% if order.product.image %}
                  <img src="{{ order.product.image.url }}" alt="{{ order.product.name }}" class="h-10 w-10 rounded object-cover mr-3">
                  {% else %}
                  <div class="h-10 w-10 rounded object-cover mr-3 bg-gray-200 flex items-center justify-center">
                    <i class="fas fa-mobile-alt text-gray-500"></i>
                  </div>
                  {% endif %}
                  <div class="text-sm font-medium text-gray-900">{{ order.product.name }}</div>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                {{ order.product.price|currency }}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                {{ order.quantity }}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">
                {{ order.total_price|currency }}
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                  {% if order.status == 'Pending' %}bg-yellow-100 text-yellow-800
                  {% elif order.status == 'Paid' %}bg-blue-100 text-blue-800
                  {% elif order.status == 'Shipped' %}bg-indigo-100 text-indigo-800
                  {% elif order.status == 'Done' %}bg-green-100 text-green-800
                  {% elif order.status == 'Canceled' %}bg-red-100 text-red-800
                  {% endif %}">
                  {{ order.status }}
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                {{ order.created_at|date:"d M Y" }}
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="7" class="px-6 py-12 text-center">
                <i class="fas fa-clipboard-list text-5xl text-gray-300 mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-2">Belum ada pesanan</h3>
                <p class="text-gray-500">Pesanan Anda akan muncul di sini setelah Anda melakukan pembelian</p>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      
      <!-- Mobile View - Card layout for better mobile experience -->
      <div id="mobile-orders-list" class="md:hidden grid grid-cols-1 gap-4 p-4">
        {% for order in orders %}
        <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow fade-in mobile-order-card" data-order-id="{{ order.order_id }}">
          <div class="flex justify-between items-start mb-3">
            <div class="font-medium text-gray-900">{{ order.order_id }}</div>
            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
              {% if order.status == 'Pending' %}bg-yellow-100 text-yellow-800
              {% elif order.status == 'Paid' %}bg-blue-100 text-blue-800
              {% elif order.status == 'Shipped' %}bg-indigo-100 text-indigo-800
              {% elif order.status == 'Done' %}bg-green-100 text-green-800
              {% elif order.status == 'Canceled' %}bg-red-100 text-red-800
              {% endif %}">
              {{ order.status }}
            </span>
          </div>
          <div class="flex items-center mb-3">
            {% if order.product.image %}
            <img src="{{ order.product.image.url }}" alt="{{ order.product.name }}" class="h-12 w-12 rounded object-cover mr-3">
            {% else %}
            <div class="h-12 w-12 rounded object-cover mr-3 bg-gray-200 flex items-center justify-center">
              <i class="fas fa-mobile-alt text-gray-500"></i>
            </div>
            {% endif %}
            <div class="text-sm font-medium text-gray-900">{{ order.product.name }}</div>
          </div>
          <div class="space-y-1 text-sm">
            <div class="flex justify-between">
              <span class="text-gray-500">Harga:</span>
              <span class="text-gray-900">{{ order.product.price|currency }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-500">Jumlah:</span>
              <span class="text-gray-900">{{ order.quantity }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-500">Total:</span>
              <span class="font-semibold text-gray-900">{{ order.total_price|currency }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-500">Tanggal:</span>
              <span class="text-gray-900">{{ order.created_at|date:"d M Y" }}</span>
            </div>
          </div>
        </div>
        {% empty %}
        <div id="no-orders-mobile" class="text-center py-12">
          <i class="fas fa-clipboard-list text-5xl text-gray-300 mb-4"></i>
          <h3 class="text-lg font-medium text-gray-900 mb-2">Belum ada pesanan</h3>
          <p class="text-gray-500">Pesanan Anda akan muncul di sini setelah Anda melakukan pembelian</p>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- Empty State for Desktop when no results after search -->
    <div id="no-orders" class="{% if orders %}hidden{% endif %} text-center py-12">
      <i class="fas fa-clipboard-list text-5xl text-gray-300 mb-4"></i>
      <h3 class="text-lg font-medium text-gray-900 mb-2">Belum ada pesanan</h3>
      <p class="text-gray-500">Pesanan Anda akan muncul di sini setelah Anda melakukan pembelian</p>
    </div>

    <!-- Loading State -->
    <div id="loading-orders" class="hidden text-center py-12">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
      <p class="text-gray-500">Memuat pesanan...</p>
    </div>
  </div>
</div>

<script>
  // Status badge colors - using consistent colors with the existing theme
  const statusColors = {
    'Pending': 'bg-yellow-100 text-yellow-800',
    'Paid': 'bg-blue-100 text-blue-800',
    'Shipped': 'bg-indigo-100 text-indigo-800',
    'Done': 'bg-green-100 text-green-800',
    'Canceled': 'bg-red-100 text-red-800'
  };

  // Format date to Indonesian format
  function formatDate(dateString) {
    const options = { day: 'numeric', month: 'long', year: 'numeric' };
    return new Date(dateString).toLocaleDateString('id-ID', options);
  }

  // Format currency in Indonesian format
  function formatCurrency(amount) {
    if (!amount || amount === '0') return 'Rp0';
    // Remove any non-numeric characters except decimal point
    const num = parseFloat(amount.toString().replace(/[^0-9.]/g, ''));
    if (isNaN(num)) return 'Rp0';
    return new Intl.NumberFormat('id-ID', {
      style: 'currency',
      currency: 'IDR',
      minimumFractionDigits: 0
    }).format(num);
  }

  // Filter orders by search query
  function filterOrders(query) {
    if (!query.trim()) {
      // Show all orders if search is empty
      document.querySelectorAll('.order-row, .mobile-order-card').forEach(el => {
        el.style.display = 'table-row';
        el.classList.remove('hidden');
        // Add animation
        el.style.opacity = '0';
        el.style.transform = 'translateY(10px)';
        setTimeout(() => {
          el.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
          el.style.opacity = '1';
          el.style.transform = 'translateY(0)';
        }, 10);
      });
      document.querySelectorAll('.mobile-order-card').forEach(card => {
        card.style.display = 'block';
      });
      document.getElementById('no-orders').classList.add('hidden');
      document.getElementById('no-orders-mobile').classList.add('hidden');
      return;
    }

    const lowerCaseQuery = query.toLowerCase();
    
    // Filter desktop table rows
    const tableRows = document.querySelectorAll('.order-row');
    let visibleCount = 0;
    
    tableRows.forEach(row => {
      const orderId = row.getAttribute('data-order-id').toLowerCase();
      if (orderId.includes(lowerCaseQuery)) {
        row.style.display = 'table-row';
        row.style.opacity = '0';
        row.style.transform = 'translateY(10px)';
        setTimeout(() => {
          row.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
          row.style.opacity = '1';
          row.style.transform = 'translateY(0)';
        }, 10);
        visibleCount++;
      } else {
        row.style.display = 'none';
      }
    });
    
    // Filter mobile cards
    const mobileCards = document.querySelectorAll('.mobile-order-card');
    mobileCards.forEach(card => {
      const orderId = card.getAttribute('data-order-id').toLowerCase();
      if (orderId.includes(lowerCaseQuery)) {
        card.style.display = 'block';
        card.style.opacity = '0';
        card.style.transform = 'translateY(10px)';
        setTimeout(() => {
          card.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
          card.style.opacity = '1';
          card.style.transform = 'translateY(0)';
        }, 10);
      } else {
        card.style.display = 'none';
      }
    });

    // Show/hide empty state
    if (visibleCount === 0) {
      document.getElementById('no-orders').classList.remove('hidden');
      document.getElementById('no-orders-mobile').classList.remove('hidden');
    } else {
      document.getElementById('no-orders').classList.add('hidden');
      document.getElementById('no-orders-mobile').classList.add('hidden');
    }
  }

  // Initialize the page
  document.addEventListener('DOMContentLoaded', function() {
    // Set up search functionality
    const searchInput = document.getElementById('order-search');
    const searchButton = document.getElementById('search-btn');

    searchButton.addEventListener('click', function() {
      const query = searchInput.value.trim();
      filterOrders(query);
    });

    searchInput.addEventListener('input', function() {
      // Live search with debounce to prevent too many updates
      clearTimeout(this.debounceTimer);
      this.debounceTimer = setTimeout(() => {
        const query = searchInput.value.trim();
        filterOrders(query);
      }, 300); // Wait 300ms after user stops typing
    });

    searchInput.addEventListener('keyup', function(event) {
      if (event.key === 'Escape') {
        // Clear search when ESC is pressed
        searchInput.value = '';
        filterOrders('');
      } else if (event.key === 'Enter') {
        event.preventDefault(); // Prevent form submission
        const query = searchInput.value.trim();
        filterOrders(query);
        clearTimeout(this.debounceTimer);
      }
    });

    // Add fade-in animation to the container
    const container = document.getElementById('orders-container');
    container.classList.add('fade-in');
    
    // Add focus effect to search input
    searchInput.addEventListener('focus', function() {
      this.parentElement.classList.add('ring-2', 'ring-primary');
    });
    
    searchInput.addEventListener('blur', function() {
      this.parentElement.classList.remove('ring-2', 'ring-primary');
    });
    
    // Add swipe functionality for mobile view
    let touchStartX = 0;
    let touchEndX = 0;
    
    document.addEventListener('touchstart', e => {
      touchStartX = e.changedTouches[0].screenX;
    }, false);
    
    document.addEventListener('touchend', e => {
      touchEndX = e.changedTouches[0].screenX;
      handleSwipeGesture();
    }, false);
    
    function handleSwipeGesture() {
      const minSwipeDistance = 50;
      
      if (touchStartX - touchEndX > minSwipeDistance) {
        // Swipe left - could implement next page
      } else if (touchEndX - touchStartX > minSwipeDistance) {
        // Swipe right - could implement previous page
      }
    }
    
    // If there's a search query in the input field from the page load, trigger a search
    if (searchInput.value.trim()) {
      setTimeout(() => {
        filterOrders(searchInput.value.trim());
      }, 500);
    }
  });
</script>
{% endblock content %}